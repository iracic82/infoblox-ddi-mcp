name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv venv --python 3.12

      - name: Install ruff
        run: uv pip install ruff

      - name: Ruff check
        run: uv run ruff check mcp_intent.py services/

      - name: Ruff format check
        run: uv run ruff format --check mcp_intent.py services/

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python and install dependencies
        run: |
          uv venv --python ${{ matrix.python-version }}
          uv pip install -r requirements.txt
          uv pip install pytest pytest-asyncio

      - name: Syntax check
        run: uv run python -c "import py_compile; py_compile.compile('mcp_intent.py', doraise=True); print('OK')"

      - name: Verify 20 tools registered
        run: |
          count=$(grep -c '@mcp.tool(' mcp_intent.py)
          echo "Found $count tools"
          [ "$count" -eq 20 ] || (echo "Expected 20 tools, found $count" && exit 1)

      - name: Verify imports
        run: |
          uv run python -c "
          import mcp_intent;
          print('Version:', mcp_intent.__version__);
          print('Server name:', mcp_intent.mcp.name)
          "

      - name: Run tests
        env:
          INFOBLOX_API_KEY: test_key_for_ci
        run: uv run python -m pytest tests/ -v

  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t infoblox-ddi-mcp:test .

      - name: Verify image
        run: |
          docker run --rm infoblox-ddi-mcp:test python -c "
          import mcp_intent;
          print('Version:', mcp_intent.__version__);
          print('Module loaded successfully')
          "
